---
title: 构建一种面向应用的区块链底层
date: 2018/9/28 22:22:22
tags:
  - blockchain
  - token
  - DAC
categories: Blockchain
---

&#160; &#160; &#160; &#160;以太坊希望将底层的区块链作为操作系统，在其之上运行一切DAPP。这个想法很宏伟和激动人心，但是从现在的情况来看，无需去再一次提及其性能如何，单就讨论在其上发布和运行的各种无用和毫无疑义的智能合约吞噬了主网资源，甚至一度使其瘫痪。这不应该是其所谓的"世界计算机"应该有的表现。至于后来发布的Sharding、Casper、Plasma等技术手段来提高主链性能的方式也并不能掩盖其设计的一些问题。从本质上来说，除了链即服务以外，像以太坊的这种形式来实现区块链应用落地是不现实的。下文就以几个出现在现有以太坊体系上的问题作为开端，对其设计的不合理性作以详细说明以及由此提出更好的方案。   

<!-- more -->

# 当前的问题

## 以太坊智能合约的实用性问题  
&#160; &#160; &#160; &#160;首先来聊聊智能合约吧，智能合约之父Nick Szabo关于智能合约的设想[The Idea of Smart Contracts ](http://www.fon.hum.uva.nl/rob/Courses/InformationInSpeech/CDROM/Literature/LOTwinterschool2006/szabo.best.vwh.net/idea.html)并不是非常完善和具有概括性，以下文字很好的诠释了智能合约：

>一个智能合约(Smart contract)是一个计算化交易协议，用来执行合约条款。智能合约设计的通常目的是为了满足一般的合同条件(譬如支付条款，扣押令，私密性，甚至是执法)，最大限度减少恶意和意外的状况，最大限度减少使用信任式中间媒介。相关的经济目标包括降低欺诈损失，仲裁和执法成本，还有其它的交易成本。[^1]

&#160; &#160; &#160; &#160;可以说智能合约是一套 代码化的**约定—执行**体系 。如上所述其设计的目的也是为了满足一般的合同条件，那这样的约束就将智能合约在现实世界的作用和应用范围缩小了很多。很多情况下智能合约都不能接受外部世界的状态，原因是可信程度。就拿最常被举的例子：一位老人想要智能合约帮他完成过世后遗产的继承。这种事件的处理在现实世界十分顺畅和简易，只需要照着老人的遗嘱走法律程序即可。那么在没有现实世界法律体系的智能合约上该怎么处理呢？按照把大象放进冰箱的步骤走，应该是在某个时刻外部触发这份合约执行，合约通过判断是否达成条件来执行合约。那么问题来了，如何判断他本人过世这一条件是否达成？这个API来自什么地方，是否可信？最无解的地方就在这里，想要抛弃现实世界可能造假的传统合约而特立独行的智能合约在这里只能向外部世界妥协求援。好了，在这里就可以结束这场闹剧了。或许智能合约的拥护者应该已经将上面的例子吐槽千百遍。如果这种场景需要用到智能合约，那么最好有预言机(Oracle)的存在。前面大费周章的举出这么一个老掉牙的例子，是为了说明智能合约在如今并不能广泛的应用到很多领域，而这也恰恰是一众区块链项目所吹嘘的伟大的、革命性的东西。显然I don't buy it!  看看以太坊上所有的智能合约都能做什么吧，除了五花八门的ICO合约和许多类似于Fomo3D这类考验人性游戏类合约外可以说都是一堆复制了ERC20标准到处乱贴的垃圾代码。实用性在除了ICO和自嗨的以太坊狂热者自身之外的地方没有任何体现。  

## EVM存在的合理性和必要性  

&#160; &#160; &#160; &#160;这个问题要在不同的场景下讨论，假如EVM是用来实现 以太坊和一众信徒所期待的那个智能合约 这一场景来看，EVM是一个会让所有人失望的东西。因为图灵完备的EVM却遇到了作用域十分有限的智能合约，图灵完备并不能让EVM能够达到大家所期望的智能合约应有的效果，尤其是为了防止合约代码死循环而设定的执行步骤限制，也就是Gas系统。还有以太坊对于合约逻辑和最终合约交易执行的捆绑，这些都让智能合约止步于非常有限的操作。可以说EVM是一个 因未来的智能合约可能需要 而催生出来但是却被捆绑着的DSL，华丽而且无用。如果在承认了智能合约的作用域十分有限的情况下，EVM应该尽可能的简化，砍掉一些编程方面的灵活性而加入模块化的设计，做到更加方便、简洁和安全。当然很多人不会对EVM和智能合约死心，那就再谈以太坊智能合约体系的真正软肋：合约在发布那一刻就已经死去。  

&#160; &#160; &#160; &#160;目前以太坊智能合约的设计将通证和业务逻辑紧紧捆绑在所谓的智能合约里，极大制约了业务本身的拓展和升级，甚至我们可以说，以太坊的智能合约强迫开发者在发布他们的合约时预知和决定未来的一切。显然这是不合理的代码独裁，这种冷冰冰的设计有着其独到的见解但也高傲和愚蠢，开发者必须戴着镣铐跳舞还要表现出享受的姿态，仿佛一旦你不称赞或者认同这种为了去中心化而作出的僵硬设计你就会被踢出区块链的世界。另一方面，以太坊主网本身要承载所有合约的执行，这种情况的确是符合区块链教义的。为此付出的代价就是，主网资源的巨大牺牲。要知道比起以太坊本身的交易，那些智能合约代码所要耗费的计算资源的确大了很多。  

&#160; &#160; &#160; &#160;综合上面所说的情况，可以解释部分”以太坊上的智能合约为何都是一些鸡肋无用的小把戏“这一情况了。

## 理想的情况

&#160; &#160; &#160; &#160;区块链应用该以什么形式出现，以太坊已经举了反例。其实在区块链应用方面，IBM的Farbic给了我们很好的启示和可借鉴的地方，当然也有其不足之处。在Fabric里，通证和业务逻辑的耦合不再那么紧密，出现了链代码这个概念。如果说智能合约真的能成为极客和大众所期望的形式，一种妥协的、可能的实现办法就是链代码形式。首先链代码确保了能够真正实现业务逻辑而非被（因为安全而设计却又无法保证安全的）智能合约语言紧紧束缚，并没有实质性的功能。比起遵循死板的某种DSL，区块链更应该作为可信的价值体系来帮助重构一些已经存在的业务。应该尊重业务，跟业务很好的分割开来。区块链和应用的耦合关系应该从代码逻辑和通证体系分开来看。运行区块链主网的节点负责的是承载应用以及作为主网价值的维护者，而具体的业务需要专门的链代码来处理。而通证则是一条维系着区块链和传统业务的纽带。所形成的整个业务体系就像传统软件设计的理念一样，高内聚，低耦合。这样来看区块链应该是一个第三方的模块，很容易融入业务体系，而不是作为一种颠覆性的、破坏性的平台，要求所有业务搬迁到链上。现有的应用绝对不会交出用户交出流量向现有千千万万企图成为底层操作系统的公链妥协。

## 一种面向业务的区块链应用体系设计

&#160; &#160; &#160; &#160;Talk is cheap , show me something useful !  
&#160; &#160; &#160; &#160;个人认为，在区块链体系里构建一种高可用性应用应该遵循的理念是：节点承载应用，应用产生社群，社群反作用于体系而形成 **链—应用—社群** 的闭环，这样才有利于区块链形成真正的生态而非冷酷的代码独裁。  

> 节点：TIC主链节点  
> 应用：DAPP（执行特定逻辑的链代码，和某种资产进行交互）

![image-20181012122351796](/images/image-20181012122351796.png)

&#160; &#160; &#160; &#160;在一个具体的业务场景里，整个体系分成区块链底层和应用层。区块链底层负责构建去中心化的价值网络，拥有主链唯一的通证，作为唯一的可信价值代表。同时，承载一切形式的通证发行，包括utility token 、security token等，作为业务和应用的价值代表，流通在对应的业务体系中，可以享受到区块链的一切特性。在Bancor协议的支持下，非主链通证可以跟主链货币进行有价值依靠的转换，实现了一种主链体系下的跨链操作，与此同时跨业务的通证交换和流转也能轻松进行。最后，区块链底层的非主链通证向外部提供必要的API用于交互。应用层作为业务逻辑的主要实现，需要有其具体的程序，通过调用区块链提供的对应通证操作API来将通证纳入到应用中来，使应用对通证的操作就像操作数据库一样。业务逻辑编写完成后，将整个代码发布到区块链网络中进行部署。这一步如同以太坊合约发布一样，需要缴纳手续费，但是与之不同的是运行主网的节点有选择是否接受的权利，符合区块链原则、100%见证的应用需要达成一定的条件让全网来接受，除此之外的应用可以付出一定的报酬来吸引愿意安装的节点安装并向外界提供应用的服务，尽管这样的设计牺牲了可信度，就像一些区块链项目的侧链一样，但是这种设计类似于联盟链，联盟链是被人们所认可和接受的，况且这只是是可选情况之一。

&#160; &#160; &#160; &#160;从具体的操作上展开，一个区块链应用，或者说一个包含通证体系的业务构建，在区块链上的操作主要包括以下三个过程：
### 逻辑链层的搭建
&#160; &#160; &#160; &#160;链层类似于以太坊的智能合约、Fabric的链代码，用来实现具体业务操作。
> 租赁节点（服务器）类似于租赁服务器等计算资源。  
> 部署链代码（程序）将应用程序发布到区块链网络，等待节点部署，根据达成条件的不同，可能为全网部署，也可能是部分节点部署。

### 通证的发布
&#160; &#160; &#160; &#160;TIC体系下的通证，如果是符合Bancor协议的本质可交易通证，默认锚定TIC。一方面增加了通证的实用性，另一方面为跨链带来一条可能途径。
> 发行通证需要锚定到TIC（默认），规定发行量、精度等通证参数。

### 链层和通证的耦合
&#160; &#160; &#160; &#160;通证可以抽象为数据库，所有链逻辑最终进行的操作本质上是传统数据库的CRUD操作。因此我们对建立在TIC体系的通证进行统一化的抽象和封装，暴露出三个编程接口：查询(retrive)/兑换(exchange)/转移(transfer)。链代码通过调用上述接口即可完成对通证的操作，就完成了业务逻辑。链和通证的耦合需要通过公钥加密体系来认证，认证通过后可以将通证挂载在链上。
> 挂载：每个通证都会注册在主链上，链注册在部分节点上，每个链对应一个地址（类比于ERC20的合约体系），将指向通证的事务转发给对应的链便是完成了把通证挂载在链上。当挂载成功后，主链会将指向通证的内部事务（查询/转移）转发给注册在该节点上的链，主链只处理外部事物（兑换）。

![77924304.png](/images/TAC-APP-Token.png)

&#160; &#160; &#160; &#160;这个想法还有不成熟和不周到的地方，比如非主链通证的安全性、处理链代码的升级带来的负面影响等，欢迎批评指正。如果对于我的想法有更深入的理解和有趣的建议请联系我或者评论留言 ：）当然也欢迎打赏  ：P

[^1]: _The New Palgrave: Allocation, Information, and Markets_